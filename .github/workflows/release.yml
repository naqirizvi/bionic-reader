name: Release Extension

on:
  push:
    tags:
      - 'v*.*.*'  # Triggers on version tags like v1.0.0, v2.0.0, etc.

jobs:
  build-and-release:
    runs-on: ubuntu-latest
    permissions:
      contents: write  # Required to create releases and upload assets
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Fetch all history for tags
      
      - name: Get version from tag
        id: get_version
        run: echo "VERSION=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT
      
      - name: Create extension zip
        run: |
          zip -r bionic-reader.zip \
            _locales/ \
            background.js \
            css/ \
            fonts/ \
            images/ \
            index.html \
            manifest.json \
            options.js \
            src/ \
            -x "*.DS_Store" "*.git*"
      
      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          files: bionic-reader.zip
          name: Release ${{ steps.get_version.outputs.VERSION }}
          body: |
            ## Bionic Reader Extension ${{ steps.get_version.outputs.VERSION }}
            
            ### Installation
            1. Download `bionic-reader.zip` from the assets below
            2. Extract the zip file
            3. Open Chrome and navigate to `chrome://extensions/`
            4. Enable "Developer mode" in the top right
            5. Click "Load unpacked" and select the extracted folder
            
            ### Changes
            See commit history for detailed changes.
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Publish to Chrome Web Store (v2+)
        if: startsWith(github.ref, 'refs/tags/v2') || startsWith(github.ref, 'refs/tags/v3') || startsWith(github.ref, 'refs/tags/v4') || startsWith(github.ref, 'refs/tags/v5')
        uses: mnao305/chrome-extension-upload@v5.0.0
        with:
          file-path: bionic-reader.zip
          extension-id: ${{ secrets.CHROME_EXTENSION_ID }}
          client-id: ${{ secrets.CHROME_CLIENT_ID }}
          client-secret: ${{ secrets.CHROME_CLIENT_SECRET }}
          refresh-token: ${{ secrets.CHROME_REFRESH_TOKEN }}
          publish: true

